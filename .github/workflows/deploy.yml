name: deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout the repo
        uses: actions/checkout@main

      - name: Deployment with SSH Action
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            set -e

            echo -e "\n>>> Updating deploy folder"
            cd /root/deploy/django-deployment/
            git pull

            echo -e "\n>>> Stopping Gunicorn"
            cd /app/
            . env/bin/activate
            ./scripts/super.sh stop gunicorn

            echo -e "\n>>> Deleting old files"
            rm -rf /app/django-deployment
            rm -rf /app/config
            rm -rf /app/scripts
            rm -rf /app/docker

            echo -e "\n>>> Copying new files"
            cp -r /root/deploy/django-deployment /app/
            mv /app/django-deployment/config /app/
            mv /app/django-deployment/scripts /app/
            mv /app/django-deployment/docker /app/
            mv /app/django-deployment/requirements.txt /app/

            echo -e "\n>>> Installing Python packages"
            pip install -r /app/requirements.txt

            echo -e "\n>>> Running Django migrations"
            /app/django-deployment/manage.py migrate

            echo -e "\n>>> Collecting static files"
            /app/django-deployment/manage.py collectstatic

            echo -e "\n>>> Re-reading Supervisord config"
            /app/scripts/super.sh reread

            echo -e "\n>>> Starting Gunicorn"
            /app/scripts/super.sh start gunicorn